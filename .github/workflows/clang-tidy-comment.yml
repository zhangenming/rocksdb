name: Post clang-tidy PR comment
on:
  workflow_run:
    workflows: ["facebook/rocksdb/pr-jobs"]
    types: [completed]

permissions:
  pull-requests: write

jobs:
  comment:
    if: github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - name: Download clang-tidy results
      id: download
      uses: actions/download-artifact@v4.0.0
      with:
        name: clang-tidy-result
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
    - name: Post or update PR comment
      if: steps.download.outcome == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (!fs.existsSync('clang-tidy-comment.md') || !fs.existsSync('pr_number.txt')) {
            core.info('No clang-tidy results found; skipping.');
            return;
          }
          const body = fs.readFileSync('clang-tidy-comment.md', 'utf8');
          const prNumber = parseInt(fs.readFileSync('pr_number.txt', 'utf8').trim());
          const marker = '<!-- clang-tidy-bot -->';
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          const existing = comments.find(c => c.body.includes(marker));
          if (existing) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existing.id,
              body,
            });
            core.info(`Updated existing comment ${existing.id}`);
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
            core.info('Created new PR comment');
          }
