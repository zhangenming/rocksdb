name: clang-tidy
on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  clang-tidy:
    if: github.repository_owner == 'facebook'
    runs-on:
      labels: 4-core-ubuntu
    container:
      image: ghcr.io/facebook/rocksdb_ubuntu:24.0
    steps:
    - uses: actions/checkout@v4.1.0
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 2
    - name: Mark workspace as safe for git
      run: git config --global --add safe.directory $GITHUB_WORKSPACE
    - name: Install clang-tidy
      run: apt-get update && apt-get install -y clang-tidy
    - name: Generate compile_commands.json
      run: |
        mkdir build && cd build
        cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
              -DCMAKE_C_COMPILER=clang-18 \
              -DCMAKE_CXX_COMPILER=clang++-18 ..
        cd ..
        ln -sf build/compile_commands.json compile_commands.json
    - name: Run clang-tidy on changed files
      id: clang-tidy
      run: |
        python3 tools/run_clang_tidy.py \
          -j 4 \
          --diff-base HEAD~1 \
          --github-annotations \
          --github-step-summary \
          --comment-output clang-tidy-comment.md
      continue-on-error: true
    - name: Post clang-tidy results to PR
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const commentPath = 'clang-tidy-comment.md';
          if (!fs.existsSync(commentPath)) {
            core.info('No comment file generated; skipping PR comment.');
            return;
          }
          const body = fs.readFileSync(commentPath, 'utf8');
          const marker = '<!-- clang-tidy-bot -->';
          const prNumber = context.payload.pull_request.number;
          try {
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            const existing = comments.find(c => c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
              core.info(`Updated existing comment ${existing.id}`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
              core.info('Created new PR comment');
            }
          } catch (err) {
            core.warning(`Could not post PR comment: ${err.message}`);
          }
    - name: Fail if clang-tidy found issues
      if: steps.clang-tidy.outcome == 'failure'
      run: exit 1
